<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portland Events</title>
  <style>
    body {font-family: Arial, sans-serif; margin: 2rem; background:#f9f9f9;}
    h1 {text-align:center;}
    table {width:100%; border-collapse:collapse; margin-top:1rem;}
    th, td {border:1px solid #ddd; padding:0.5rem; text-align:left;}
    th {background:#eee;}
    a {color:#0066cc; text-decoration:none;}
    a:hover {text-decoration:underline;}
    #error-message {color:red; text-align:center; margin-top:1rem; display:none;}
    .loading {text-align:center; margin-top:1rem;}
  </style>
</head>
<body>

<h1>Portland Events</h1>
<p style="text-align:center;">
  Upcoming events in Portland, OR. All types—music, art, festivals, and more.<br>
  Updated <span id="last-updated">…</span>.
</p>

<div id="error-message">Could not load events – check the console.</div>
<div class="loading" id="loading">Loading events…</div>

<table id="events-table">
  <thead>
    <tr>
      <th>Date/Time</th>
      <th>Event Title</th>
      <th>Venue</th>
      <th>Tags</th>
      <th>Price</th>
      <th>Age</th>
      <th>Organizer</th>
      <th>Tickets</th>
      <th>Sort Date</th>
    </tr>
  </thead>
  <tbody>
    <!-- Filled by JavaScript -->
  </tbody>
</table>

<h2>Recurring Events</h2>
<p>Example: Woodstock Farmers Market – Every Sunday. Check sources for details.</p>

<script>
  async function fetchEventsFromSheet() {
    const sheetId = '1-h7u488sVWTwNtSsAd7W55tEchWknQZHHeltptrxW48';
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=Sheet1`;

    try {
      const resp = await fetch(sheetUrl);
      const txt  = await resp.text();
      const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\((.+)\);/)[1]);

      const rows = json.table.rows;
      const tbody = document.querySelector('#events-table tbody');
      tbody.innerHTML = '';                 // clear placeholder

      rows.forEach(r => {
        const c = r.c.map(cell => cell ? cell.v : 'TBD');
        const rowHtml = `
          <tr>
            <td>${c[0]}</td>
            <td>${c[1]}</td>
            <td>${c[2]}</td>
            <td>${c[3]}</td>
            <td>${c[4]}</td>
            <td>${c[5]}</td>
            <td>${c[6]}</td>
            <td><a href="${c[7]}" target="_blank">Tickets</a></td>
            <td>${c[8]}</td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', rowHtml);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('last-updated').textContent = new Date().toLocaleDateString();
    } catch (e) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-message').style.display = 'block';
      console.error('Sheet fetch error:', e);
    }
  }

  // Run on page load
  fetchEventsFromSheet();
</script>

</body>
</html>